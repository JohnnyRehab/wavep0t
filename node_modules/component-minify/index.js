const CleanCSS = require('clean-css');
const uglifyJS = require('uglify-js');

function minify(builder) {
  const build = builder.build;

  // monkey patch build to perform minification after compilation
  // better api could look builder.hook('after build', fn)
  builder.build = function(fn) {
    build.call(builder, function(err, res) {
      if (err) return fn(err);
      if (res.css) res.css = new CleanCSS(exports.cleanCSS).minify(res.css);
      if (res.js) res.js = uglifyJS.minify(res.js, exports.uglifyJS).code;
      if (res.require) res.require = uglifyJS.minify(res.require, exports.uglifyJS).code;
      fn(err, res);
    });
  };
}

// expose minify function
module.exports = exports = minify;

// expose options to use programmatically
exports.cleanCSS = {};
exports.uglifyJS = { fromString: true };
